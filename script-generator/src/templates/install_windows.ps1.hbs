#Requires -RunAsAdministrator
<#
.SYNOPSIS
    Orizon Zero Trust Connect - Windows Agent Installation Script
    Version: 3.0.0 - Enhanced Edition with Security Hardening

.DESCRIPTION
    This script installs the Orizon Zero Trust agent on Windows systems.
    It performs a security audit, provides interactive hardening options,
    and sets up reverse SSH tunnels to the Hub.

.PARAMETER NonInteractive
    Skip interactive prompts and use secure defaults

.NOTES
    Generated: {{timestamp}}
    Node: {{nodeName}}
    Supported: Windows 10/11, Windows Server 2016+
#>

param(
    [switch]$NonInteractive = $false
)

# +===============================================================+
# |                    CONFIGURATION                              |
# +===============================================================+

$Script:Config = @{
    HubHost = "{{hubHost}}"
    HubSshPort = {{hubSshPort}}
    AgentToken = "{{agentToken}}"
    NodeId = "{{nodeId}}"
    TunnelType = "{{tunnelType}}"
    ApiBaseUrl = "{{apiBaseUrl}}"
    NodeName = "{{nodeName}}"
    TerminalLocalPort = {{localSshPort}}
    TerminalRemotePort = {{terminalTunnelPort}}
    HttpsLocalPort = {{localHttpsPort}}
    HttpsRemotePort = {{httpsTunnelPort}}
}

# Agent paths
$Script:AgentDir = "C:\Program Files\Orizon"
$Script:SshKeyDir = "$Script:AgentDir\.ssh"
$Script:ConfigFile = "$Script:AgentDir\config.json"

# Security Score
$Script:SecurityScore = 0
$Script:MaxScore = 100

# Hardening options
$Script:HardenFirewall = $true
$Script:HardenDefender = $true
$Script:HardenSmb = $true
$Script:HardenRdp = $false
$Script:HardenAudit = $true

# +===============================================================+
# |                    UTILITY FUNCTIONS                          |
# +===============================================================+

function Write-Banner {
    $banner = @"

+===============================================================+
|       ORIZON ZERO TRUST CONNECT - AGENT INSTALLER            |
|                    Version 3.0.0                             |
+===============================================================+
|  Node: $($Script:Config.NodeName)
|  Hub:  $($Script:Config.HubHost):$($Script:Config.HubSshPort)
+===============================================================+

"@
    Write-Host $banner -ForegroundColor Cyan
}

function Write-Section {
    param([string]$Title)
    Write-Host ""
    Write-Host ("=" * 65) -ForegroundColor Blue
    Write-Host "  $Title" -ForegroundColor White
    Write-Host ("=" * 65) -ForegroundColor Blue
}

function Write-Ok {
    param([string]$Message)
    Write-Host "[OK] " -ForegroundColor Green -NoNewline
    Write-Host $Message
}

function Write-Warn {
    param([string]$Message)
    Write-Host "[!!] " -ForegroundColor Yellow -NoNewline
    Write-Host $Message
}

function Write-Fail {
    param([string]$Message)
    Write-Host "[X] " -ForegroundColor Red -NoNewline
    Write-Host $Message
}

function Write-Info {
    param([string]$Message)
    Write-Host "[i] " -ForegroundColor Cyan -NoNewline
    Write-Host $Message
}

function Ask-YesNo {
    param(
        [string]$Prompt,
        [bool]$Default = $true
    )

    if ($NonInteractive) {
        return $Default
    }

    $suffix = if ($Default) { "[Y/n]" } else { "[y/N]" }
    $response = Read-Host "$Prompt $suffix"

    if ([string]::IsNullOrWhiteSpace($response)) {
        return $Default
    }

    return $response -match "^[Yy]"
}

# +===============================================================+
# |                    EXISTING INSTALLATION CHECK                |
# +===============================================================+

$Script:ExistingInstallation = $false
$Script:InstallAction = "install"

function Test-ExistingInstallation {
    $Script:ExistingInstallation = $false

    # Check for agent directory and config
    if ((Test-Path $Script:AgentDir) -and (Test-Path $Script:ConfigFile)) {
        $Script:ExistingInstallation = $true
        return $true
    }

    # Check for running scheduled tasks
    $tasks = Get-ScheduledTask -TaskName "Orizon*" -ErrorAction SilentlyContinue
    if ($tasks) {
        $Script:ExistingInstallation = $true
        return $true
    }

    return $false
}

function Show-ExistingStatus {
    Write-Host ""
    Write-Host "+===============================================================+" -ForegroundColor Yellow
    Write-Host "|           EXISTING INSTALLATION DETECTED                      |" -ForegroundColor Yellow
    Write-Host "+===============================================================+" -ForegroundColor Yellow
    Write-Host ""

    if (Test-Path $Script:ConfigFile) {
        try {
            $config = Get-Content $Script:ConfigFile | ConvertFrom-Json

            Write-Host "Current Configuration:" -ForegroundColor White
            Write-Host "   Node ID:      $($config.nodeId)"
            Write-Host "   Node Name:    $($config.nodeName)"
            Write-Host "   Hub:          $($config.hubHost)"
            Write-Host "   Installed:    $($config.installedAt)"
            Write-Host ""
        } catch {
            Write-Warn "Could not read existing configuration"
        }
    }

    Write-Host "Tunnel Services Status:" -ForegroundColor White

    $terminalTask = Get-ScheduledTask -TaskName "OrizonTunnelTerminal" -ErrorAction SilentlyContinue
    if ($terminalTask) {
        if ($terminalTask.State -eq "Running") {
            Write-Ok "Terminal tunnel: RUNNING"
        } else {
            Write-Warn "Terminal tunnel: $($terminalTask.State)"
        }
    } else {
        Write-Fail "Terminal tunnel: NOT CONFIGURED"
    }

    $httpsTask = Get-ScheduledTask -TaskName "OrizonTunnelHttps" -ErrorAction SilentlyContinue
    if ($httpsTask) {
        if ($httpsTask.State -eq "Running") {
            Write-Ok "HTTPS tunnel: RUNNING"
        } else {
            Write-Warn "HTTPS tunnel: $($httpsTask.State)"
        }
    } else {
        Write-Fail "HTTPS tunnel: NOT CONFIGURED"
    }

    # Check SSH key
    if (Test-Path "$Script:SshKeyDir\id_ed25519.pub") {
        Write-Ok "SSH key: PRESENT"
    } else {
        Write-Fail "SSH key: MISSING"
    }

    Write-Host ""
}

function Get-ExistingAction {
    Write-Host "What would you like to do?" -ForegroundColor White
    Write-Host ""
    Write-Host "   [1] " -ForegroundColor Green -NoNewline
    Write-Host "Upgrade/Update - Update configuration and services"
    Write-Host "   [2] " -ForegroundColor Yellow -NoNewline
    Write-Host "Modify - Change tunnel ports or hub connection"
    Write-Host "   [3] " -ForegroundColor Red -NoNewline
    Write-Host "Uninstall - Remove agent and tunnel services"
    Write-Host "   [4] " -ForegroundColor Cyan -NoNewline
    Write-Host "Status Only - Run security audit and show current status"
    Write-Host "   [5] Cancel - Exit without changes"
    Write-Host ""

    $choice = Read-Host "Select option [1-5]"

    switch ($choice) {
        "1" {
            $Script:InstallAction = "upgrade"
            Write-Info "Selected: Upgrade/Update"
        }
        "2" {
            $Script:InstallAction = "modify"
            Write-Info "Selected: Modify configuration"
        }
        "3" {
            $Script:InstallAction = "uninstall"
            Write-Warn "Selected: Uninstall"
        }
        "4" {
            $Script:InstallAction = "status"
            Write-Info "Selected: Status only"
        }
        default {
            $Script:InstallAction = "cancel"
            Write-Info "Installation cancelled"
            exit 0
        }
    }
}

# +===============================================================+
# |                    UNINSTALL FUNCTION                         |
# +===============================================================+

function Uninstall-Agent {
    Write-Section "UNINSTALLING ORIZON AGENT"
    Write-Host ""

    Write-Host "WARNING: This will remove all Orizon components:" -ForegroundColor Red
    Write-Host "   * Stop and remove scheduled tasks"
    Write-Host "   * Remove agent directory ($Script:AgentDir)"
    Write-Host "   * Remove SSH keys"
    Write-Host ""

    if (-not $NonInteractive) {
        $confirm = Ask-YesNo "Are you sure you want to uninstall?" $false
        if (-not $confirm) {
            Write-Info "Uninstall cancelled"
            return
        }
    }

    Write-Host ""

    # Stop and remove scheduled tasks
    Write-Host "Stopping tunnel services..." -ForegroundColor White
    $tasks = Get-ScheduledTask -TaskName "Orizon*" -ErrorAction SilentlyContinue
    foreach ($task in $tasks) {
        try {
            Stop-ScheduledTask -TaskName $task.TaskName -ErrorAction SilentlyContinue
            Unregister-ScheduledTask -TaskName $task.TaskName -Confirm:$false -ErrorAction SilentlyContinue
            Write-Ok "Removed task: $($task.TaskName)"
        } catch {
            Write-Warn "Could not remove task: $($task.TaskName)"
        }
    }

    # Kill any running SSH processes for tunnels
    Get-Process -Name "ssh" -ErrorAction SilentlyContinue | Where-Object {
        $_.Path -like "*Orizon*"
    } | Stop-Process -Force -ErrorAction SilentlyContinue

    # Remove agent directory
    Write-Host "Removing agent directory..." -ForegroundColor White
    if (Test-Path $Script:AgentDir) {
        Remove-Item -Path $Script:AgentDir -Recurse -Force -ErrorAction SilentlyContinue
        Write-Ok "Agent directory removed"
    }

    Write-Host ""
    Write-Host "+===============================================================+" -ForegroundColor Green
    Write-Host "|              UNINSTALL COMPLETE                               |" -ForegroundColor Green
    Write-Host "+===============================================================+" -ForegroundColor Green
    Write-Host ""
    Write-Info "Orizon Agent has been completely removed from this system."
    Write-Host ""

    exit 0
}

# +===============================================================+
# |                    SYSTEM DETECTION                           |
# +===============================================================+

function Get-WindowsInfo {
    $os = Get-CimInstance Win32_OperatingSystem
    $isServer = $os.Caption -match "Server"

    $Script:WindowsInfo = @{
        Name = $os.Caption
        Version = $os.Version
        Build = $os.BuildNumber
        IsServer = $isServer
        Architecture = $env:PROCESSOR_ARCHITECTURE
    }

    Write-Info "OS: $($Script:WindowsInfo.Name)"
    Write-Info "Version: $($Script:WindowsInfo.Version) (Build $($Script:WindowsInfo.Build))"
    Write-Info "Type: $(if ($isServer) { 'Server' } else { 'Client' })"
}

# +===============================================================+
# |                    SECURITY AUDIT                             |
# +===============================================================+

function Invoke-SecurityAudit {
    Write-Section "PHASE 1: SECURITY AUDIT"
    Write-Host ""
    Write-Host "Analyzing current security configuration..." -ForegroundColor White
    Write-Host ""

    $Script:SecurityScore = 0

    # 1. Windows Firewall
    Write-Host "--- WINDOWS FIREWALL ---" -ForegroundColor White

    $Script:FirewallStatus = @{
        Enabled = $false
        Profiles = @{}
    }

    try {
        $profiles = Get-NetFirewallProfile -ErrorAction SilentlyContinue
        $allEnabled = $true

        foreach ($profile in $profiles) {
            $Script:FirewallStatus.Profiles[$profile.Name] = $profile.Enabled
            if (-not $profile.Enabled) { $allEnabled = $false }
        }

        if ($allEnabled) {
            $Script:FirewallStatus.Enabled = $true
            Write-Ok "Windows Firewall: ENABLED on all profiles"
            $Script:SecurityScore += 15
        } else {
            $enabledProfiles = ($Script:FirewallStatus.Profiles.GetEnumerator() | Where-Object { $_.Value } | ForEach-Object { $_.Key }) -join ", "
            if ($enabledProfiles) {
                Write-Warn "Windows Firewall: Partial ($enabledProfiles)"
                $Script:SecurityScore += 10
            } else {
                Write-Fail "Windows Firewall: DISABLED on all profiles"
            }
        }
    } catch {
        Write-Fail "Could not check Windows Firewall status"
    }
    Write-Host ""

    # 2. Windows Defender
    Write-Host "--- WINDOWS DEFENDER ---" -ForegroundColor White

    $Script:DefenderStatus = @{
        Enabled = $false
        RealTimeProtection = $false
    }

    try {
        $defender = Get-MpComputerStatus -ErrorAction SilentlyContinue
        if ($defender) {
            $Script:DefenderStatus.Enabled = $defender.AntivirusEnabled
            $Script:DefenderStatus.RealTimeProtection = $defender.RealTimeProtectionEnabled

            if ($defender.AntivirusEnabled) {
                Write-Ok "Windows Defender: ENABLED"
                $Script:SecurityScore += 10

                if ($defender.RealTimeProtectionEnabled) {
                    Write-Ok "Real-time Protection: ENABLED"
                    $Script:SecurityScore += 10
                } else {
                    Write-Fail "Real-time Protection: DISABLED"
                }
            } else {
                Write-Fail "Windows Defender: DISABLED"
            }
        }
    } catch {
        Write-Warn "Could not check Windows Defender status"
    }
    Write-Host ""

    # 3. SMB Configuration
    Write-Host "--- SMB CONFIGURATION ---" -ForegroundColor White

    $Script:SmbStatus = @{
        V1Enabled = $false
    }

    try {
        $smbv1 = Get-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -ErrorAction SilentlyContinue
        if ($smbv1.State -eq "Enabled") {
            $Script:SmbStatus.V1Enabled = $true
            Write-Fail "SMBv1: ENABLED (Security Risk)"
        } else {
            Write-Ok "SMBv1: DISABLED"
            $Script:SecurityScore += 10
        }
    } catch {
        Write-Info "Could not check SMB configuration"
    }
    Write-Host ""

    # 4. Remote Desktop
    Write-Host "--- REMOTE DESKTOP ---" -ForegroundColor White

    $Script:RdpStatus = @{
        Enabled = $false
        NLA = $false
    }

    try {
        $rdp = Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -ErrorAction SilentlyContinue
        if ($rdp.fDenyTSConnections -eq 0) {
            $Script:RdpStatus.Enabled = $true
            Write-Warn "Remote Desktop: ENABLED"

            $nla = Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -ErrorAction SilentlyContinue
            if ($nla.UserAuthentication -eq 1) {
                $Script:RdpStatus.NLA = $true
                Write-Ok "Network Level Authentication: ENABLED"
                $Script:SecurityScore += 5
            } else {
                Write-Fail "Network Level Authentication: DISABLED"
            }
        } else {
            Write-Ok "Remote Desktop: DISABLED"
            $Script:SecurityScore += 5
        }
    } catch {
        Write-Info "Could not check Remote Desktop status"
    }
    Write-Host ""

    # 5. Audit Logging
    Write-Host "--- AUDIT LOGGING ---" -ForegroundColor White

    try {
        $eventLog = Get-Service -Name "EventLog" -ErrorAction SilentlyContinue
        if ($eventLog.Status -eq "Running") {
            Write-Ok "Windows Event Log: RUNNING"
            $Script:SecurityScore += 5
        }
    } catch {
        Write-Info "Could not check audit logging"
    }
    Write-Host ""

    # 6. Open Ports
    Write-Host "--- OPEN PORTS (TCP LISTENING) ---" -ForegroundColor White
    Write-Host ""

    $Script:OpenPorts = @()

    Write-Host ("   {0,-8} {1,-15} {2,-20} {3}" -f "PORT", "PROTO", "PROCESS", "NOTE") -ForegroundColor White
    Write-Host "   " + ("-" * 55)

    try {
        $connections = Get-NetTCPConnection -State Listen -ErrorAction SilentlyContinue |
            Select-Object LocalPort, OwningProcess |
            Sort-Object LocalPort -Unique |
            Select-Object -First 15

        foreach ($conn in $connections) {
            $port = $conn.LocalPort
            $process = "unknown"

            try {
                $proc = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
                if ($proc) { $process = $proc.ProcessName.Substring(0, [Math]::Min(18, $proc.ProcessName.Length)) }
            } catch {}

            $note = switch ($port) {
                22 { "Orizon SSH" }
                443 { "HTTPS" }
                3389 { "RDP" }
                445 { "SMB" }
                139 { "NetBIOS" }
                135 { "RPC" }
                default { "" }
            }

            Write-Host ("   {0,-8} {1,-15} {2,-20} {3}" -f $port, "tcp", $process, $note)
            $Script:OpenPorts += @{ Port = $port; Process = $process }
        }
    } catch {
        Write-Warn "Could not enumerate open ports"
    }

    Write-Host ""
    Write-Info "Total open ports: $($Script:OpenPorts.Count)"

    if ($Script:OpenPorts.Count -le 10) {
        $Script:SecurityScore += 10
    }
    Write-Host ""

    # Security Score
    Write-Host "============================================================" -ForegroundColor White
    Write-Host "                    SECURITY SCORE                          " -ForegroundColor White
    Write-Host "============================================================" -ForegroundColor White

    $scoreColor = if ($Script:SecurityScore -ge 70) { "Green" }
                  elseif ($Script:SecurityScore -ge 50) { "Yellow" }
                  else { "Red" }

    $scoreLabel = if ($Script:SecurityScore -ge 70) { "GOOD" }
                  elseif ($Script:SecurityScore -ge 50) { "NEEDS IMPROVEMENT" }
                  else { "CRITICAL" }

    Write-Host ""
    Write-Host "          Current Score: " -NoNewline
    Write-Host "$($Script:SecurityScore)/100 - $scoreLabel" -ForegroundColor $scoreColor
    Write-Host ""
}

# +===============================================================+
# |                    INTERACTIVE HARDENING                      |
# +===============================================================+

function Invoke-InteractiveHardening {
    Write-Section "PHASE 2: HARDENING CONFIGURATION"
    Write-Host ""

    # 1. Windows Firewall
    Write-Host "--- [1/4] WINDOWS FIREWALL ---" -ForegroundColor Cyan

    if (-not $Script:FirewallStatus.Enabled) {
        Write-Host ""
        Write-Host "   Windows Firewall is not fully enabled."
        Write-Host ""

        $Script:HardenFirewall = Ask-YesNo "   Enable Windows Firewall on all profiles?" $true
        if ($Script:HardenFirewall) {
            Write-Ok "Windows Firewall will be enabled"
        }
    } else {
        Write-Ok "Windows Firewall already enabled"
        $Script:HardenFirewall = $false
    }
    Write-Host ""

    # 2. Windows Defender
    Write-Host "--- [2/4] WINDOWS DEFENDER ---" -ForegroundColor Cyan

    if (-not $Script:DefenderStatus.RealTimeProtection) {
        Write-Host ""
        $Script:HardenDefender = Ask-YesNo "   Enable Windows Defender real-time protection?" $true
        if ($Script:HardenDefender) {
            Write-Ok "Windows Defender will be configured"
        }
    } else {
        Write-Ok "Windows Defender already configured"
        $Script:HardenDefender = $false
    }
    Write-Host ""

    # 3. SMB
    Write-Host "--- [3/4] SMB HARDENING ---" -ForegroundColor Cyan

    if ($Script:SmbStatus.V1Enabled) {
        Write-Host ""
        Write-Host "   SMBv1 is outdated and has vulnerabilities." -ForegroundColor Yellow
        Write-Host ""

        $Script:HardenSmb = Ask-YesNo "   Disable SMBv1 protocol?" $true
        if ($Script:HardenSmb) {
            Write-Ok "SMBv1 will be disabled"
        }
    } else {
        Write-Ok "SMBv1 already disabled"
        $Script:HardenSmb = $false
    }
    Write-Host ""

    # 4. Audit
    Write-Host "--- [4/4] AUDIT LOGGING ---" -ForegroundColor Cyan
    Write-Host ""

    $Script:HardenAudit = Ask-YesNo "   Enable enhanced security auditing?" $true
    if ($Script:HardenAudit) {
        Write-Ok "Enhanced auditing will be configured"
    }
    Write-Host ""
}

# +===============================================================+
# |                    APPLY HARDENING                            |
# +===============================================================+

function Invoke-ApplyHardening {
    Write-Section "PHASE 3: APPLYING SECURITY HARDENING"
    Write-Host ""

    if ($Script:HardenFirewall) {
        Write-Host "[1/4] Configuring Windows Firewall..." -ForegroundColor White
        try {
            Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True -ErrorAction Stop
            Write-Ok "Windows Firewall enabled"
        } catch {
            Write-Warn "Could not enable Windows Firewall: $_"
        }
        Write-Host ""
    }

    if ($Script:HardenDefender) {
        Write-Host "[2/4] Configuring Windows Defender..." -ForegroundColor White
        try {
            Set-MpPreference -DisableRealtimeMonitoring $false -ErrorAction Stop
            Write-Ok "Windows Defender configured"
        } catch {
            Write-Warn "Could not configure Defender: $_"
        }
        Write-Host ""
    }

    if ($Script:HardenSmb) {
        Write-Host "[3/4] Disabling SMBv1..." -ForegroundColor White
        try {
            Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -NoRestart -ErrorAction Stop | Out-Null
            Write-Ok "SMBv1 disabled (restart required)"
        } catch {
            Write-Warn "Could not disable SMBv1: $_"
        }
        Write-Host ""
    }

    if ($Script:HardenAudit) {
        Write-Host "[4/4] Configuring Audit Logging..." -ForegroundColor White
        try {
            auditpol /set /subcategory:"Logon" /success:enable /failure:enable 2>&1 | Out-Null
            auditpol /set /subcategory:"Account Lockout" /failure:enable 2>&1 | Out-Null
            Write-Ok "Audit logging configured"
        } catch {
            Write-Warn "Could not configure audit: $_"
        }
        Write-Host ""
    }

    Write-Ok "Security hardening applied"
}

# +===============================================================+
# |                    AGENT INSTALLATION                         |
# +===============================================================+

function Install-Dependencies {
    Write-Section "PHASE 4: INSTALLING DEPENDENCIES"
    Write-Host ""

    Write-Host "Checking OpenSSH Client..." -ForegroundColor White

    $sshCapability = Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH.Client*'
    if ($sshCapability.State -ne "Installed") {
        Write-Info "Installing OpenSSH Client..."
        try {
            Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0 -ErrorAction Stop | Out-Null
            Write-Ok "OpenSSH Client installed"
        } catch {
            Write-Warn "Could not install OpenSSH: $_"
        }
    } else {
        Write-Ok "OpenSSH Client already installed"
    }
    Write-Host ""
}

function Install-Agent {
    Write-Section "PHASE 5: SETTING UP ORIZON AGENT"
    Write-Host ""

    Write-Host "Creating agent directory..." -ForegroundColor White
    if (-not (Test-Path $Script:AgentDir)) {
        New-Item -ItemType Directory -Path $Script:AgentDir -Force | Out-Null
    }
    if (-not (Test-Path $Script:SshKeyDir)) {
        New-Item -ItemType Directory -Path $Script:SshKeyDir -Force | Out-Null
    }
    Write-Ok "Agent directory: $Script:AgentDir"
    Write-Host ""

    Write-Host "Generating SSH key pair..." -ForegroundColor White
    $keyPath = "$Script:SshKeyDir\id_ed25519"

    if (-not (Test-Path $keyPath)) {
        try {
            ssh-keygen -t ed25519 -f $keyPath -N '""' -C "orizon-agent-$($Script:Config.NodeId)" 2>&1 | Out-Null
            Write-Ok "SSH key generated"
        } catch {
            Write-Warn "Could not generate SSH key: $_"
        }
    } else {
        Write-Info "SSH key already exists"
    }
    Write-Host ""

    Write-Host "Registering SSH key with Hub..." -ForegroundColor White
    try {
        $publicKey = Get-Content "$keyPath.pub" -ErrorAction Stop

        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

        $body = @{ publicKey = $publicKey } | ConvertTo-Json
        $response = Invoke-RestMethod -Uri "$($Script:Config.ApiBaseUrl)/nodes/$($Script:Config.NodeId)/register-key" `
            -Method POST `
            -ContentType "application/json" `
            -Body $body `
            -Headers @{ "Authorization" = "Bearer $($Script:Config.AgentToken)" } `
            -ErrorAction SilentlyContinue

        Write-Ok "SSH key registered with Hub"
    } catch {
        Write-Warn "Could not register key: $_"
    }
    Write-Host ""

    Write-Host "Creating agent configuration..." -ForegroundColor White
    $config = @{
        nodeId = $Script:Config.NodeId
        nodeName = $Script:Config.NodeName
        hubHost = $Script:Config.HubHost
        hubSshPort = $Script:Config.HubSshPort
        tunnels = @{
            terminal = @{
                localPort = $Script:Config.TerminalLocalPort
                remotePort = $Script:Config.TerminalRemotePort
            }
            https = @{
                localPort = $Script:Config.HttpsLocalPort
                remotePort = $Script:Config.HttpsRemotePort
            }
        }
        installedAt = (Get-Date -Format "o")
    }

    $config | ConvertTo-Json -Depth 5 | Out-File -FilePath $Script:ConfigFile -Encoding UTF8
    Write-Ok "Configuration saved"
    Write-Host ""
}

# +===============================================================+
# |                    TUNNEL SERVICES                            |
# +===============================================================+

function Install-TunnelServices {
    Write-Section "PHASE 6: CREATING TUNNEL SERVICES"
    Write-Host ""

    $sshKeyPath = "$Script:SshKeyDir\id_ed25519"

    Write-Host "Creating tunnel scripts..." -ForegroundColor White

    # Terminal Tunnel
    $terminalScript = @"
@echo off
:loop
ssh -N -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL -i "$sshKeyPath" -p $($Script:Config.HubSshPort) -R $($Script:Config.TerminalRemotePort):localhost:$($Script:Config.TerminalLocalPort) $($Script:Config.NodeId)@$($Script:Config.HubHost)
timeout /t 10
goto loop
"@
    $terminalScript | Out-File -FilePath "$Script:AgentDir\tunnel-terminal.bat" -Encoding ASCII

    # HTTPS Tunnel
    $httpsScript = @"
@echo off
:loop
ssh -N -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL -i "$sshKeyPath" -p $($Script:Config.HubSshPort) -R $($Script:Config.HttpsRemotePort):localhost:$($Script:Config.HttpsLocalPort) $($Script:Config.NodeId)@$($Script:Config.HubHost)
timeout /t 10
goto loop
"@
    $httpsScript | Out-File -FilePath "$Script:AgentDir\tunnel-https.bat" -Encoding ASCII

    Write-Ok "Tunnel scripts created"
    Write-Host ""

    Write-Host "Creating Windows Scheduled Tasks..." -ForegroundColor White

    # Terminal Task
    $terminalAction = New-ScheduledTaskAction -Execute "$Script:AgentDir\tunnel-terminal.bat" -WorkingDirectory $Script:AgentDir
    $terminalTrigger = New-ScheduledTaskTrigger -AtStartup
    $terminalPrincipal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
    $terminalSettings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)

    try {
        Unregister-ScheduledTask -TaskName "Orizon-Tunnel-Terminal" -Confirm:$false -ErrorAction SilentlyContinue
        Register-ScheduledTask -TaskName "Orizon-Tunnel-Terminal" -Action $terminalAction -Trigger $terminalTrigger -Principal $terminalPrincipal -Settings $terminalSettings -Description "Orizon Terminal Tunnel" -ErrorAction Stop | Out-Null
        Write-Ok "Terminal tunnel task created"
    } catch {
        Write-Warn "Could not create terminal task: $_"
    }

    # HTTPS Task
    $httpsAction = New-ScheduledTaskAction -Execute "$Script:AgentDir\tunnel-https.bat" -WorkingDirectory $Script:AgentDir
    $httpsTrigger = New-ScheduledTaskTrigger -AtStartup
    $httpsPrincipal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
    $httpsSettings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)

    try {
        Unregister-ScheduledTask -TaskName "Orizon-Tunnel-HTTPS" -Confirm:$false -ErrorAction SilentlyContinue
        Register-ScheduledTask -TaskName "Orizon-Tunnel-HTTPS" -Action $httpsAction -Trigger $httpsTrigger -Principal $httpsPrincipal -Settings $httpsSettings -Description "Orizon HTTPS Tunnel" -ErrorAction Stop | Out-Null
        Write-Ok "HTTPS tunnel task created"
    } catch {
        Write-Warn "Could not create HTTPS task: $_"
    }

    Write-Host ""

    Write-Host "Starting tunnel tasks..." -ForegroundColor White
    try {
        Start-ScheduledTask -TaskName "Orizon-Tunnel-Terminal" -ErrorAction SilentlyContinue
        Start-ScheduledTask -TaskName "Orizon-Tunnel-HTTPS" -ErrorAction SilentlyContinue
        Write-Ok "Tunnel tasks started"
    } catch {
        Write-Warn "Could not start tasks: $_"
    }

    Write-Host ""
    Start-Sleep -Seconds 3

    $terminalTask = Get-ScheduledTask -TaskName "Orizon-Tunnel-Terminal" -ErrorAction SilentlyContinue
    $httpsTask = Get-ScheduledTask -TaskName "Orizon-Tunnel-HTTPS" -ErrorAction SilentlyContinue

    if ($terminalTask) {
        Write-Ok "Terminal tunnel: Ready"
    }
    if ($httpsTask) {
        Write-Ok "HTTPS tunnel: Ready"
    }
    Write-Host ""
}

# +===============================================================+
# |                    HARDENING REPORT                           |
# +===============================================================+

function Send-HardeningReport {
    Write-Section "PHASE 7: SENDING HARDENING REPORT"
    Write-Host ""

    Write-Host "Sending security status to Hub..." -ForegroundColor White

    try {
        $profiles = @{}
        Get-NetFirewallProfile -ErrorAction SilentlyContinue | ForEach-Object {
            $profiles[$_.Name] = $_.Enabled
        }

        $defender = Get-MpComputerStatus -ErrorAction SilentlyContinue

        $payload = @{
            agent_token = $Script:Config.AgentToken
            firewall = @{
                enabled = ($profiles.Values -contains $true)
                profiles = $profiles
            }
            antivirus = @{
                enabled = if ($defender) { $defender.AntivirusEnabled } else { $false }
                real_time_protection = if ($defender) { $defender.RealTimeProtectionEnabled } else { $false }
                product_name = "Windows Defender"
            }
            open_ports = @()
            security_modules = @(
                @{ name = "Windows Firewall"; status = "enabled" }
            )
            ssl_info = @{
                openssl_version = "TLS 1.2 supported"
            }
            audit = @{
                enabled = $true
                service_name = "Windows Event Log"
            }
        }

        $json = $payload | ConvertTo-Json -Depth 5

        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

        Invoke-RestMethod -Uri "$($Script:Config.ApiBaseUrl)/nodes/hardening" `
            -Method POST `
            -ContentType "application/json" `
            -Body $json `
            -TimeoutSec 30 `
            -ErrorAction SilentlyContinue | Out-Null

        Write-Ok "Hardening report sent"
    } catch {
        Write-Warn "Could not send report: $_"
    }
    Write-Host ""
}

# +===============================================================+
# |                    SUMMARY                                    |
# +===============================================================+

function Write-Summary {
    Write-Host ""
    Write-Host "============================================================" -ForegroundColor Green
    Write-Host "              INSTALLATION COMPLETE                         " -ForegroundColor Green
    Write-Host "============================================================" -ForegroundColor Green
    Write-Host ""
    Write-Host "  Node ID:    $($Script:Config.NodeId)" -ForegroundColor Green
    Write-Host "  Node Name:  $($Script:Config.NodeName)" -ForegroundColor Green
    Write-Host "  Hub:        $($Script:Config.HubHost):$($Script:Config.HubSshPort)" -ForegroundColor Green
    Write-Host ""
    Write-Host "  Tunnels:" -ForegroundColor Green
    Write-Host "    Terminal: localhost:$($Script:Config.TerminalLocalPort) -> Hub:$($Script:Config.TerminalRemotePort)" -ForegroundColor Green
    Write-Host "    HTTPS:    localhost:$($Script:Config.HttpsLocalPort) -> Hub:$($Script:Config.HttpsRemotePort)" -ForegroundColor Green
    Write-Host ""
    Write-Host "  Commands:" -ForegroundColor Green
    Write-Host "    Get-ScheduledTask -TaskName 'Orizon-*'" -ForegroundColor Green
    Write-Host ""
}

# +===============================================================+
# |                    MAIN                                       |
# +===============================================================+

function Main {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Host "This script must be run as Administrator" -ForegroundColor Red
        exit 1
    }

    Write-Banner
    Get-WindowsInfo
    Write-Host ""

    # Check for existing installation
    if (Test-ExistingInstallation) {
        Show-ExistingStatus

        if (-not $NonInteractive) {
            Get-ExistingAction
        } else {
            Write-Info "Non-interactive mode: proceeding with upgrade"
            $Script:InstallAction = "upgrade"
        }

        # Handle uninstall
        if ($Script:InstallAction -eq "uninstall") {
            Uninstall-Agent
            exit 0
        }

        # Handle status-only
        if ($Script:InstallAction -eq "status") {
            Invoke-SecurityAudit
            Write-Host ""
            Write-Info "Status check complete. No changes made."
            exit 0
        }

        # For modify or upgrade, continue
        Write-Info "Proceeding with $($Script:InstallAction)..."
        Write-Host ""
    }

    Invoke-SecurityAudit
    Invoke-InteractiveHardening

    Write-Section "PLANNED CHANGES"
    Write-Host ""
    if ($Script:HardenFirewall) { Write-Host "   * Enable Windows Firewall" }
    if ($Script:HardenDefender) { Write-Host "   * Enable Windows Defender" }
    if ($Script:HardenSmb) { Write-Host "   * Disable SMBv1" }
    if ($Script:HardenAudit) { Write-Host "   * Enable audit logging" }
    Write-Host "   * Install Orizon Agent"
    Write-Host "   * Create reverse tunnels"
    Write-Host ""

    if (-not $NonInteractive) {
        $proceed = Ask-YesNo "Proceed with installation?" $true
        if (-not $proceed) {
            Write-Warn "Installation cancelled"
            exit 0
        }
    }
    Write-Host ""

    Invoke-ApplyHardening
    Install-Dependencies
    Install-Agent
    Install-TunnelServices
    Send-HardeningReport
    Write-Summary
}

Main
