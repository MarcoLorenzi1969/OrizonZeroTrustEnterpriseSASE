#!/bin/bash
#===============================================================================
#
#  ORIZON ZERO TRUST CONNECT - Interactive Setup Wizard
#  Version: 2.1.0
#
#  This wizard guides you through configuring your edge server to connect
#  to the Orizon Hub infrastructure.
#
#===============================================================================

set -euo pipefail

# Configuration
VERSION="2.1.0"
INSTALL_DIR="/opt/orizon"
CONFIG_DIR="/etc/orizon"
LOG_DIR="/var/log/orizon"
SSH_DIR="$INSTALL_DIR/.ssh"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    MAGENTA='\033[0;35m'
    CYAN='\033[0;36m'
    NC='\033[0m'
    BOLD='\033[1m'
else
    RED='' GREEN='' YELLOW='' BLUE='' MAGENTA='' CYAN='' NC='' BOLD=''
fi

show_banner() {
    clear
    echo -e "${CYAN}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════════════════════╗
    ║                                                                   ║
    ║     ██████╗ ██████╗ ██╗███████╗ ██████╗ ███╗   ██╗               ║
    ║    ██╔═══██╗██╔══██╗██║╚══███╔╝██╔═══██╗████╗  ██║               ║
    ║    ██║   ██║██████╔╝██║  ███╔╝ ██║   ██║██╔██╗ ██║               ║
    ║    ██║   ██║██╔══██╗██║ ███╔╝  ██║   ██║██║╚██╗██║               ║
    ║    ╚██████╔╝██║  ██║██║███████╗╚██████╔╝██║ ╚████║               ║
    ║     ╚═════╝ ╚═╝  ╚═╝╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═══╝               ║
    ║                                                                   ║
    ║              Zero Trust Connect - Setup Wizard                    ║
    ║                                                                   ║
    ╚═══════════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

log_info() { echo -e "${CYAN}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root"
        echo "Please run: sudo $0"
        exit 1
    fi
}

show_help() {
    echo "Orizon Zero Trust Connect - Setup Wizard v$VERSION"
    echo ""
    echo "Usage: orizon-setup [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show this help message"
    echo "  --version, -v    Show version"
    echo "  --uninstall      Remove Orizon agent and services"
    echo "  --status         Show current status of Orizon services"
    echo ""
    echo "Interactive mode:"
    echo "  Run without arguments to start the interactive setup wizard."
    echo ""
    echo "Non-interactive mode:"
    echo "  Set environment variables and run:"
    echo "    NODE_ID=<id> HUB_SERVERS=<host1:port,host2:port> orizon-setup --auto"
    echo ""
    echo "Required environment variables for --auto:"
    echo "  NODE_ID       - Your node identifier from Orizon Hub"
    echo "  HUB_SERVERS   - Comma-separated list of hub servers (host:port)"
    echo ""
    echo "Optional environment variables:"
    echo "  NODE_NAME          - Friendly name for this node (default: hostname)"
    echo "  API_BASE_URL       - Hub API URL for key registration"
    echo "  AGENT_TOKEN        - Authentication token for registration"
    echo "  LOCAL_SSH_PORT     - Local SSH port (default: 22)"
    echo "  LOCAL_HTTPS_PORT   - Local HTTPS port (default: 443)"
    echo ""
}

show_status() {
    echo ""
    echo -e "${BOLD}Orizon Agent Status${NC}"
    echo "==================="
    echo ""

    # Check services
    echo -e "${BOLD}Services:${NC}"
    for service in $(systemctl list-units --type=service --all 2>/dev/null | grep 'orizon' | awk '{print $1}'); do
        local status=$(systemctl is-active "$service" 2>/dev/null || echo "unknown")
        if [[ "$status" == "active" ]]; then
            echo -e "  ${GREEN}[RUNNING]${NC} $service"
        else
            echo -e "  ${RED}[STOPPED]${NC} $service"
        fi
    done

    echo ""
    echo -e "${BOLD}Configuration:${NC}"
    if [[ -f "$CONFIG_DIR/agent.conf" ]]; then
        source "$CONFIG_DIR/agent.conf"
        echo "  Node ID: ${NODE_ID:-Not set}"
        echo "  Node Name: ${NODE_NAME:-Not set}"
        echo "  Hub Servers: ${HUB_SERVERS:-Not set}"
    else
        echo "  No configuration file found"
    fi

    echo ""
    echo -e "${BOLD}SSH Keys:${NC}"
    if [[ -f "$SSH_DIR/id_ed25519.pub" ]]; then
        echo "  Public key: Present"
    else
        echo "  Public key: Not generated"
    fi

    echo ""
    echo -e "${BOLD}Logs:${NC}"
    echo "  Location: $LOG_DIR/"
    if ls "$LOG_DIR"/*.log &>/dev/null; then
        echo "  Recent logs: $(ls -la "$LOG_DIR"/*.log 2>/dev/null | tail -3)"
    fi
    echo ""
}

uninstall() {
    echo ""
    echo -e "${YELLOW}Uninstalling Orizon Agent...${NC}"
    echo ""

    read -p "This will remove all Orizon services and configuration. Continue? (y/N) " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Uninstall cancelled."
        exit 0
    fi

    # Stop and disable services
    for service in $(systemctl list-units --type=service --all 2>/dev/null | grep 'orizon' | awk '{print $1}'); do
        echo "  Stopping $service..."
        systemctl stop "$service" 2>/dev/null || true
        systemctl disable "$service" 2>/dev/null || true
        rm -f "/etc/systemd/system/$service" 2>/dev/null || true
    done

    systemctl daemon-reload

    # Optionally remove data
    read -p "Remove SSH keys and configuration? (y/N) " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$INSTALL_DIR/.ssh"
        rm -rf "$CONFIG_DIR"
        rm -rf "$LOG_DIR"
        echo "Data removed."
    else
        echo "Data preserved in $CONFIG_DIR and $INSTALL_DIR/.ssh"
    fi

    log_success "Orizon Agent uninstalled"
}

calculate_tunnel_ports() {
    local node_id="$1"
    local hash=$(echo -n "$node_id" | md5sum | cut -c1-8)
    local hash_dec=$((16#$hash))

    SYSTEM_TUNNEL_PORT=$((9000 + (hash_dec % 1000)))
    TERMINAL_TUNNEL_PORT=$((10000 + (hash_dec % 50000)))
    HTTPS_TUNNEL_PORT=$((TERMINAL_TUNNEL_PORT + 1))
}

wizard_step_1() {
    echo ""
    echo -e "${BOLD}STEP 1: Node Configuration${NC}"
    echo "=========================="
    echo ""
    echo "You'll need the Node ID from the Orizon Hub dashboard."
    echo "It looks like: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    echo ""

    while true; do
        read -p "Enter Node ID: " NODE_ID
        if [[ "$NODE_ID" =~ ^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$ ]]; then
            break
        else
            log_warn "Invalid Node ID format. Please try again."
        fi
    done

    read -p "Enter Node Name [$(hostname)]: " input_name
    NODE_NAME="${input_name:-$(hostname)}"

    echo ""
    log_success "Node ID: $NODE_ID"
    log_success "Node Name: $NODE_NAME"
}

wizard_step_2() {
    echo ""
    echo -e "${BOLD}STEP 2: Hub Server Configuration${NC}"
    echo "================================="
    echo ""
    echo "Enter the Hub server address(es). You can configure multiple"
    echo "hubs for redundancy. Format: host:port or just host for default port 2222"
    echo ""
    echo "Example: hub1.orizon.one:2222,hub2.orizon.one:2222"
    echo ""

    read -p "Hub Servers (comma-separated): " HUB_SERVERS

    if [[ -z "$HUB_SERVERS" ]]; then
        log_error "Hub servers are required"
        exit 1
    fi

    # Parse and validate
    HUB_HOSTS=()
    HUB_PORTS=()

    IFS=',' read -ra SERVERS <<< "$HUB_SERVERS"
    for server in "${SERVERS[@]}"; do
        server=$(echo "$server" | xargs)
        if [[ "$server" == *":"* ]]; then
            HUB_HOSTS+=("${server%:*}")
            HUB_PORTS+=("${server#*:}")
        else
            HUB_HOSTS+=("$server")
            HUB_PORTS+=("2222")
        fi
    done

    echo ""
    log_success "Configured ${#HUB_HOSTS[@]} hub server(s):"
    for i in "${!HUB_HOSTS[@]}"; do
        echo "  - Hub $((i+1)): ${HUB_HOSTS[$i]}:${HUB_PORTS[$i]}"
    done
}

wizard_step_3() {
    echo ""
    echo -e "${BOLD}STEP 3: Local Service Ports${NC}"
    echo "==========================="
    echo ""
    echo "Configure which local ports should be accessible through the tunnels."
    echo ""

    read -p "Local SSH Port [22]: " input_ssh
    LOCAL_SSH_PORT="${input_ssh:-22}"

    read -p "Local HTTPS Port [443]: " input_https
    LOCAL_HTTPS_PORT="${input_https:-443}"

    echo ""
    log_success "Local SSH Port: $LOCAL_SSH_PORT"
    log_success "Local HTTPS Port: $LOCAL_HTTPS_PORT"
}

wizard_step_4() {
    echo ""
    echo -e "${BOLD}STEP 4: Generating SSH Keys${NC}"
    echo "==========================="
    echo ""

    mkdir -p "$SSH_DIR"
    chmod 700 "$SSH_DIR"

    local key_path="$SSH_DIR/id_ed25519"

    if [[ -f "$key_path" ]]; then
        echo "SSH key already exists."
        read -p "Generate new key? (y/N) " -n 1 -r
        echo ""

        if [[ $REPLY =~ ^[Yy]$ ]]; then
            mv "$key_path" "${key_path}.backup.$(date +%Y%m%d%H%M%S)"
            mv "${key_path}.pub" "${key_path}.pub.backup.$(date +%Y%m%d%H%M%S)" 2>/dev/null || true
        else
            PUBLIC_KEY=$(cat "${key_path}.pub")
            log_success "Using existing key"
            return
        fi
    fi

    echo "Generating Ed25519 SSH key..."
    ssh-keygen -t ed25519 -f "$key_path" -N "" -C "orizon-agent-$NODE_ID" -q

    chmod 600 "$key_path"
    chmod 644 "${key_path}.pub"

    PUBLIC_KEY=$(cat "${key_path}.pub")

    echo ""
    log_success "SSH key generated"
    echo ""
    echo -e "${BOLD}Public Key:${NC}"
    echo "$PUBLIC_KEY"
    echo ""
    echo -e "${YELLOW}IMPORTANT: Copy this key to the Orizon Hub dashboard${NC}"
    echo "Navigate to: Nodes > $NODE_NAME > Settings > SSH Keys > Add Key"
    echo ""
    read -p "Press Enter when you've added the key to the Hub..."
}

wizard_step_5() {
    echo ""
    echo -e "${BOLD}STEP 5: Creating Services${NC}"
    echo "========================="
    echo ""

    # Calculate tunnel ports
    calculate_tunnel_ports "$NODE_ID"

    echo "Tunnel ports (calculated from Node ID):"
    echo "  - System: $SYSTEM_TUNNEL_PORT"
    echo "  - Terminal: $TERMINAL_TUNNEL_PORT"
    echo "  - HTTPS: $HTTPS_TUNNEL_PORT"
    echo ""

    local key_path="$SSH_DIR/id_ed25519"

    # Create services for each hub
    for i in "${!HUB_HOSTS[@]}"; do
        local hub_num=$((i + 1))
        local hub_host="${HUB_HOSTS[$i]}"
        local hub_port="${HUB_PORTS[$i]}"
        local service_name="orizon-tunnel-hub${hub_num}"

        echo "Creating service: $service_name..."

        cat > "/etc/systemd/system/${service_name}.service" << EOF
[Unit]
Description=Orizon Zero Trust SSH Tunnel - Hub${hub_num} (${hub_host})
Documentation=https://docs.orizon.one
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
Environment="AUTOSSH_GATETIME=0"
Environment="AUTOSSH_POLL=60"
ExecStart=/usr/bin/autossh -M 0 -N \\
    -o ServerAliveInterval=30 \\
    -o ServerAliveCountMax=3 \\
    -o ExitOnForwardFailure=yes \\
    -o StrictHostKeyChecking=no \\
    -o UserKnownHostsFile=/dev/null \\
    -i ${key_path} \\
    -p ${hub_port} \\
    -R ${SYSTEM_TUNNEL_PORT}:localhost:${LOCAL_SSH_PORT} \\
    -R ${TERMINAL_TUNNEL_PORT}:localhost:${LOCAL_SSH_PORT} \\
    -R ${HTTPS_TUNNEL_PORT}:localhost:${LOCAL_HTTPS_PORT} \\
    ${NODE_ID}@${hub_host}
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
        log_success "Created $service_name"
    done

    # Create watchdog service
    cat > "/etc/systemd/system/orizon-watchdog.service" << 'EOF'
[Unit]
Description=Orizon Zero Trust - Watchdog Service
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/opt/orizon/watchdog.sh
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
EOF

    # Create watchdog script
    cat > "$INSTALL_DIR/watchdog.sh" << 'WATCHDOG_EOF'
#!/bin/bash
LOG_FILE="/var/log/orizon/watchdog.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

check_and_restart() {
    local service="$1"
    if ! systemctl is-active --quiet "$service"; then
        log "Service $service is down, restarting..."
        systemctl restart "$service"
        sleep 5
        if systemctl is-active --quiet "$service"; then
            log "Service $service restarted successfully"
        else
            log "ERROR: Failed to restart $service"
        fi
    fi
}

log "Watchdog started"

while true; do
    for service in $(systemctl list-units --type=service --all | grep 'orizon-tunnel' | awk '{print $1}'); do
        check_and_restart "$service"
    done
    sleep 30
done
WATCHDOG_EOF

    chmod +x "$INSTALL_DIR/watchdog.sh"
    log_success "Created watchdog service"

    # Save configuration
    mkdir -p "$CONFIG_DIR"
    cat > "$CONFIG_DIR/agent.conf" << EOF
# Orizon Zero Trust Connect - Agent Configuration
# Generated: $(date -Iseconds)

NODE_ID="$NODE_ID"
NODE_NAME="$NODE_NAME"
HUB_SERVERS="${HUB_HOSTS[*]}"
HUB_PORTS="${HUB_PORTS[*]}"
SYSTEM_TUNNEL_PORT="$SYSTEM_TUNNEL_PORT"
TERMINAL_TUNNEL_PORT="$TERMINAL_TUNNEL_PORT"
HTTPS_TUNNEL_PORT="$HTTPS_TUNNEL_PORT"
LOCAL_SSH_PORT="$LOCAL_SSH_PORT"
LOCAL_HTTPS_PORT="$LOCAL_HTTPS_PORT"
EOF

    chmod 600 "$CONFIG_DIR/agent.conf"
    log_success "Configuration saved"
}

wizard_step_6() {
    echo ""
    echo -e "${BOLD}STEP 6: Starting Services${NC}"
    echo "========================="
    echo ""

    systemctl daemon-reload

    # Enable and start services
    for i in "${!HUB_HOSTS[@]}"; do
        local hub_num=$((i + 1))
        local service_name="orizon-tunnel-hub${hub_num}"

        echo "Starting $service_name..."
        systemctl enable "$service_name" --quiet
        systemctl start "$service_name"

        sleep 2

        if systemctl is-active --quiet "$service_name"; then
            log_success "$service_name is running"
        else
            log_warn "$service_name may have failed - check logs with: journalctl -u $service_name"
        fi
    done

    # Start watchdog
    systemctl enable orizon-watchdog --quiet
    systemctl start orizon-watchdog
    log_success "Watchdog service started"
}

wizard_complete() {
    echo ""
    echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║           SETUP COMPLETED SUCCESSFULLY                            ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${BOLD}Node Information:${NC}"
    echo "  Node ID:   $NODE_ID"
    echo "  Node Name: $NODE_NAME"
    echo ""
    echo -e "${BOLD}Tunnel Ports:${NC}"
    echo "  System:   $SYSTEM_TUNNEL_PORT"
    echo "  Terminal: $TERMINAL_TUNNEL_PORT"
    echo "  HTTPS:    $HTTPS_TUNNEL_PORT"
    echo ""
    echo -e "${BOLD}Useful Commands:${NC}"
    echo "  Status:   orizon-setup --status"
    echo "  Logs:     journalctl -u orizon-tunnel-hub1 -f"
    echo "  Restart:  systemctl restart orizon-tunnel-hub1"
    echo ""
    echo -e "${BOLD}Verify Connection:${NC}"
    echo "  1. Go to Orizon Hub dashboard"
    echo "  2. Navigate to Nodes > $NODE_NAME"
    echo "  3. Status should show 'Online'"
    echo ""
}

run_wizard() {
    show_banner
    check_root

    echo "This wizard will guide you through configuring the Orizon agent."
    echo ""
    read -p "Press Enter to continue..."

    wizard_step_1
    wizard_step_2
    wizard_step_3
    wizard_step_4
    wizard_step_5
    wizard_step_6
    wizard_complete
}

# Main
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --version|-v)
        echo "Orizon Setup Wizard v$VERSION"
        ;;
    --status)
        check_root
        show_status
        ;;
    --uninstall)
        check_root
        uninstall
        ;;
    *)
        run_wizard
        ;;
esac
