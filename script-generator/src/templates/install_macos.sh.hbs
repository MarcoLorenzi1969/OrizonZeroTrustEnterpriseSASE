#!/bin/bash
#
# Orizon Zero Trust Connect - macOS Agent Installation Script
# Generated: {{timestamp}}
# Node: {{nodeName}}
#

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   Orizon Zero Trust Connect - Agent Installation          â•‘"
echo "â•‘   Node: {{nodeName}}                                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Configuration
HUB_HOST="{{hubHost}}"
HUB_SSH_PORT="{{hubSshPort}}"
AGENT_TOKEN="{{agentToken}}"
NODE_ID="{{nodeId}}"
TUNNEL_TYPE="{{tunnelType}}"
API_BASE_URL="{{apiBaseUrl}}"

# Applications and ports
{{#each applicationPorts}}
APP_{{@key}}_LOCAL="{{this.local}}"
APP_{{@key}}_REMOTE="{{this.remote}}"
{{/each}}

echo "ğŸ“¦ 1. Checking dependencies..."
if ! command -v curl &> /dev/null; then
    echo "âŒ curl not found. Please install Xcode Command Line Tools:"
    echo "   xcode-select --install"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "ğŸ“¥ Installing jq..."
    if command -v brew &> /dev/null; then
        brew install jq
    else
        echo "âŒ Homebrew not found. Please install jq manually or install Homebrew first."
        exit 1
    fi
fi

echo ""
echo "ğŸ“¥ 2. Downloading Orizon agent..."
AGENT_DIR="/opt/orizon-agent"
sudo mkdir -p "$AGENT_DIR"

# Download agent binary for macOS
curl -fsSL "${API_BASE_URL}/agent/download/macos" -o /tmp/orizon-agent
sudo mv /tmp/orizon-agent "$AGENT_DIR/orizon-agent"
sudo chmod +x "$AGENT_DIR/orizon-agent"

echo ""
echo "ğŸ”§ 3. Configuring agent..."

# Create configuration file
sudo tee "$AGENT_DIR/config.json" > /dev/null <<EOF
{
  "nodeId": "$NODE_ID",
  "agentToken": "$AGENT_TOKEN",
  "hubHost": "$HUB_HOST",
  "hubSshPort": $HUB_SSH_PORT,
  "tunnelType": "$TUNNEL_TYPE",
  "apiBaseUrl": "$API_BASE_URL",
  "applications": {
{{#each applicationPorts}}
    "{{@key}}": {
      "localPort": {{this.local}},
      "remotePort": {{this.remote}}
    }{{#unless @last}},{{/unless}}
{{/each}}
  }
}
EOF

echo ""
echo "ğŸ”‘ 4. Setting up SSH tunnel authentication..."

# Generate SSH key pair if not exists
SSH_KEY_DIR="$AGENT_DIR/.ssh"
sudo mkdir -p "$SSH_KEY_DIR"
if [ ! -f "$SSH_KEY_DIR/id_ed25519" ]; then
    sudo ssh-keygen -t ed25519 -f "$SSH_KEY_DIR/id_ed25519" -N "" -C "orizon-agent-$NODE_ID"
fi

# Register public key with hub
PUBLIC_KEY=$(sudo cat "$SSH_KEY_DIR/id_ed25519.pub")
REGISTER_RESPONSE=$(curl -fsSL -X POST "${API_BASE_URL}/nodes/$NODE_ID/register-key" \
    -H "Authorization: Bearer $AGENT_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"publicKey\": \"$PUBLIC_KEY\"}")

if echo "$REGISTER_RESPONSE" | jq -e '.success' > /dev/null 2>&1; then
    echo "âœ… SSH key registered successfully"
else
    echo "âŒ Failed to register SSH key: $REGISTER_RESPONSE"
    exit 1
fi

echo ""
echo "ğŸš€ 5. Creating LaunchDaemon..."

sudo tee /Library/LaunchDaemons/com.orizon.agent.plist > /dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.orizon.agent</string>
    <key>ProgramArguments</key>
    <array>
        <string>$AGENT_DIR/orizon-agent</string>
        <string>start</string>
    </array>
    <key>WorkingDirectory</key>
    <string>$AGENT_DIR</string>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>
    <key>StandardOutPath</key>
    <string>/var/log/orizon-agent.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/orizon-agent-error.log</string>
</dict>
</plist>
EOF

sudo launchctl load /Library/LaunchDaemons/com.orizon.agent.plist

echo ""
echo "â³ 6. Waiting for agent to connect..."
sleep 5

# Check agent status
if sudo launchctl list | grep -q "com.orizon.agent"; then
    echo "âœ… Agent is running"

    # Verify tunnels
    echo ""
    echo "ğŸ” Tunnel status:"
{{#each applicationPorts}}
    echo "   - {{@key}}: localhost:{{this.local}} â†’ $HUB_HOST:{{this.remote}}"
{{/each}}
else
    echo "âŒ Agent failed to start. Check logs: tail -f /var/log/orizon-agent-error.log"
    exit 1
fi

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… INSTALLATION COMPLETE                                 â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  Node ID: $NODE_ID                                         â•‘"
echo "â•‘  Hub: $HUB_HOST:$HUB_SSH_PORT                              â•‘"
echo "â•‘  Tunnel Type: $TUNNEL_TYPE                                 â•‘"
echo "â•‘                                                            â•‘"
echo "â•‘  Useful commands:                                          â•‘"
echo "â•‘  - Check status: sudo launchctl list | grep orizon         â•‘"
echo "â•‘  - View logs: tail -f /var/log/orizon-agent.log            â•‘"
echo "â•‘  - Restart: sudo launchctl kickstart -kp system/com.orizon.agent â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
