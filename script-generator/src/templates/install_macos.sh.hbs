#!/bin/bash
#
# Orizon Zero Trust Connect - macOS Agent Installation Script
# Version: 3.0.0 - Enhanced Edition with Security Hardening
# Generated: {{timestamp}}
# Node: {{nodeName}}
#
# Supported: macOS 10.15+ (Catalina and later)
#

set -e

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    CONFIGURATION                              ║
# ╚═══════════════════════════════════════════════════════════════╝

HUB_HOST="{{hubHost}}"
HUB_SSH_PORT="{{hubSshPort}}"
AGENT_TOKEN="{{agentToken}}"
NODE_ID="{{nodeId}}"
TUNNEL_TYPE="{{tunnelType}}"
API_BASE_URL="{{apiBaseUrl}}"
NODE_NAME="{{nodeName}}"

# Tunnel ports
TERMINAL_LOCAL_PORT={{localSshPort}}
TERMINAL_REMOTE_PORT={{terminalTunnelPort}}
HTTPS_LOCAL_PORT={{localHttpsPort}}
HTTPS_REMOTE_PORT={{httpsTunnelPort}}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    UTILITY FUNCTIONS                          ║
# ╚═══════════════════════════════════════════════════════════════╝

print_banner() {
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════════╗"
    echo "║       ORIZON ZERO TRUST CONNECT - AGENT INSTALLER            ║"
    echo "║                    Version 3.0.0                             ║"
    echo "╠═══════════════════════════════════════════════════════════════╣"
    echo "║  Node: ${NODE_NAME}"
    echo "║  Hub:  ${HUB_HOST}:${HUB_SSH_PORT}"
    echo "╚═══════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

print_section() {
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${WHITE}  $1${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
}

print_ok() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_warn() {
    echo -e "${YELLOW}[⚠]${NC} $1"
}

print_fail() {
    echo -e "${RED}[✗]${NC} $1"
}

print_info() {
    echo -e "${CYAN}[i]${NC} $1"
}

ask_yes_no() {
    local prompt="$1"
    local default="${2:-y}"
    local answer

    if [[ "$default" == "y" ]]; then
        prompt="$prompt [Y/n]: "
    else
        prompt="$prompt [y/N]: "
    fi

    read -p "$prompt" answer
    answer=${answer:-$default}

    [[ "${answer}" == "y" || "${answer}" == "Y" || "${answer}" == "yes" ]]
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    EXISTING INSTALLATION CHECK                ║
# ╚═══════════════════════════════════════════════════════════════╝

EXISTING_INSTALLATION="false"
EXISTING_CONFIG=""

check_existing_installation() {
    AGENT_DIR="/opt/orizon-agent"
    CONFIG_FILE="$AGENT_DIR/config.json"
    EXISTING_INSTALLATION="false"

    if [ -d "$AGENT_DIR" ] && [ -f "$CONFIG_FILE" ]; then
        EXISTING_INSTALLATION="true"
        EXISTING_CONFIG=$(cat "$CONFIG_FILE" 2>/dev/null || true)
    fi

    # Check for running LaunchDaemons (ignore errors)
    if launchctl list 2>/dev/null | grep -q "com.orizon.tunnel"; then
        EXISTING_INSTALLATION="true"
    fi

    # Always return 0 to avoid set -e exit
    return 0
}

show_existing_status() {
    echo ""
    echo -e "${YELLOW}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${YELLOW}║           EXISTING INSTALLATION DETECTED                      ║${NC}"
    echo -e "${YELLOW}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    AGENT_DIR="/opt/orizon-agent"
    CONFIG_FILE="$AGENT_DIR/config.json"

    if [ -f "$CONFIG_FILE" ]; then
        EXISTING_NODE_ID=$(grep -oE '"nodeId":\s*"[^"]+"' "$CONFIG_FILE" | cut -d'"' -f4 2>/dev/null || echo "unknown")
        EXISTING_NODE_NAME=$(grep -oE '"nodeName":\s*"[^"]+"' "$CONFIG_FILE" | cut -d'"' -f4 2>/dev/null || echo "unknown")
        EXISTING_HUB=$(grep -oE '"hubHost":\s*"[^"]+"' "$CONFIG_FILE" | cut -d'"' -f4 2>/dev/null || echo "unknown")
        INSTALLED_AT=$(grep -oE '"installedAt":\s*"[^"]+"' "$CONFIG_FILE" | cut -d'"' -f4 2>/dev/null || echo "unknown")

        echo -e "${WHITE}Current Configuration:${NC}"
        echo "   Node ID:      $EXISTING_NODE_ID"
        echo "   Node Name:    $EXISTING_NODE_NAME"
        echo "   Hub:          $EXISTING_HUB"
        echo "   Installed:    $INSTALLED_AT"
        echo ""
    fi

    echo -e "${WHITE}Tunnel Services Status:${NC}"

    if launchctl list 2>/dev/null | grep -q "com.orizon.tunnel.terminal"; then
        print_ok "Terminal tunnel: RUNNING"
    elif [ -f "/Library/LaunchDaemons/com.orizon.tunnel.terminal.plist" ]; then
        print_warn "Terminal tunnel: STOPPED (configured)"
    else
        print_fail "Terminal tunnel: NOT CONFIGURED"
    fi

    if launchctl list 2>/dev/null | grep -q "com.orizon.tunnel.https"; then
        print_ok "HTTPS tunnel: RUNNING"
    elif [ -f "/Library/LaunchDaemons/com.orizon.tunnel.https.plist" ]; then
        print_warn "HTTPS tunnel: STOPPED (configured)"
    else
        print_fail "HTTPS tunnel: NOT CONFIGURED"
    fi

    # Check SSH key
    if [ -f "$AGENT_DIR/.ssh/id_ed25519.pub" ]; then
        print_ok "SSH key: PRESENT"
    else
        print_fail "SSH key: MISSING"
    fi

    echo ""
}

prompt_existing_action() {
    echo -e "${WHITE}What would you like to do?${NC}"
    echo ""
    echo "   [1] ${GREEN}Upgrade/Update${NC} - Update configuration and services"
    echo "   [2] ${YELLOW}Modify${NC} - Change tunnel ports or hub connection"
    echo "   [3] ${RED}Uninstall${NC} - Remove agent and tunnel services"
    echo "   [4] ${CYAN}Status Only${NC} - Run security audit and show current status"
    echo "   [5] Cancel - Exit without changes"
    echo ""

    read -p "Select option [1-5]: " EXISTING_ACTION

    case "$EXISTING_ACTION" in
        1)
            ACTION="upgrade"
            print_info "Selected: Upgrade/Update"
            ;;
        2)
            ACTION="modify"
            print_info "Selected: Modify configuration"
            ;;
        3)
            ACTION="uninstall"
            print_warn "Selected: Uninstall"
            ;;
        4)
            ACTION="status"
            print_info "Selected: Status only"
            ;;
        5|*)
            ACTION="cancel"
            print_info "Installation cancelled"
            exit 0
            ;;
    esac
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    UNINSTALL FUNCTION                         ║
# ╚═══════════════════════════════════════════════════════════════╝

uninstall_agent() {
    print_section "UNINSTALLING ORIZON AGENT"
    echo ""

    echo -e "${RED}⚠ WARNING: This will remove all Orizon components:${NC}"
    echo "   • Stop and remove LaunchDaemons"
    echo "   • Remove agent directory (/opt/orizon-agent)"
    echo "   • Remove SSH keys"
    echo ""

    if [ -t 0 ]; then
        if ! ask_yes_no "Are you sure you want to uninstall?" "n"; then
            print_info "Uninstall cancelled"
            exit 0
        fi
    fi

    echo ""

    # Stop and unload LaunchDaemons
    echo -e "${WHITE}Stopping tunnel services...${NC}"
    sudo launchctl unload /Library/LaunchDaemons/com.orizon.tunnel.terminal.plist 2>/dev/null || true
    sudo launchctl unload /Library/LaunchDaemons/com.orizon.tunnel.https.plist 2>/dev/null || true
    print_ok "Tunnel services stopped"

    # Remove plist files
    echo -e "${WHITE}Removing LaunchDaemon files...${NC}"
    sudo rm -f /Library/LaunchDaemons/com.orizon.tunnel.*.plist
    print_ok "LaunchDaemon files removed"

    # Remove agent directory
    echo -e "${WHITE}Removing agent directory...${NC}"
    sudo rm -rf /opt/orizon-agent
    print_ok "Agent directory removed"

    echo ""
    echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║              UNINSTALL COMPLETE                               ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    print_info "Orizon Agent has been completely removed from this system."
    echo ""

    exit 0
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    SYSTEM DETECTION                           ║
# ╚═══════════════════════════════════════════════════════════════╝

detect_macos() {
    OS_VERSION=$(sw_vers -productVersion)
    OS_BUILD=$(sw_vers -buildVersion)
    ARCH=$(uname -m)

    print_info "macOS Version: $OS_VERSION (Build $OS_BUILD)"
    print_info "Architecture: $ARCH"
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    SECURITY AUDIT                             ║
# ╚═══════════════════════════════════════════════════════════════╝

SECURITY_SCORE=0

audit_security() {
    print_section "PHASE 1: SECURITY AUDIT"
    echo ""
    echo -e "${WHITE}Analyzing current security configuration...${NC}"
    echo ""

    SECURITY_SCORE=0

    # 1. macOS Firewall
    echo -e "${WHITE}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${WHITE}│  MACOS FIREWALL                                             │${NC}"
    echo -e "${WHITE}└─────────────────────────────────────────────────────────────┘${NC}"

    FIREWALL_ENABLED="false"
    FW_STATUS=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null | grep -c "enabled" || echo "0")
    if [ "$FW_STATUS" = "1" ]; then
        FIREWALL_ENABLED="true"
        print_ok "macOS Firewall: ENABLED"
        ((SECURITY_SCORE+=15))

        # Check stealth mode
        STEALTH=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getstealthmode 2>/dev/null | grep -c "enabled" || echo "0")
        if [ "$STEALTH" = "1" ]; then
            print_ok "Stealth Mode: ENABLED"
            ((SECURITY_SCORE+=5))
        else
            print_warn "Stealth Mode: DISABLED (recommended)"
        fi
    else
        print_fail "macOS Firewall: DISABLED"
    fi
    echo ""

    # 2. FileVault (Disk Encryption)
    echo -e "${WHITE}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${WHITE}│  DISK ENCRYPTION (FILEVAULT)                                │${NC}"
    echo -e "${WHITE}└─────────────────────────────────────────────────────────────┘${NC}"

    FILEVAULT_ENABLED="false"
    FV_STATUS=$(fdesetup status 2>/dev/null | grep -c "On" || echo "0")
    if [ "$FV_STATUS" = "1" ]; then
        FILEVAULT_ENABLED="true"
        print_ok "FileVault: ENABLED"
        ((SECURITY_SCORE+=15))
    else
        print_fail "FileVault: DISABLED (recommended for data protection)"
    fi
    echo ""

    # 3. SIP (System Integrity Protection)
    echo -e "${WHITE}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${WHITE}│  SYSTEM INTEGRITY PROTECTION (SIP)                          │${NC}"
    echo -e "${WHITE}└─────────────────────────────────────────────────────────────┘${NC}"

    SIP_ENABLED="false"
    SIP_STATUS=$(csrutil status 2>/dev/null | grep -c "enabled" || echo "0")
    if [ "$SIP_STATUS" = "1" ]; then
        SIP_ENABLED="true"
        print_ok "System Integrity Protection: ENABLED"
        ((SECURITY_SCORE+=10))
    else
        print_fail "System Integrity Protection: DISABLED (security risk)"
    fi
    echo ""

    # 4. Gatekeeper
    echo -e "${WHITE}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${WHITE}│  GATEKEEPER                                                 │${NC}"
    echo -e "${WHITE}└─────────────────────────────────────────────────────────────┘${NC}"

    GATEKEEPER_ENABLED="false"
    GK_STATUS=$(spctl --status 2>/dev/null | grep -c "enabled" || echo "0")
    if [ "$GK_STATUS" = "1" ]; then
        GATEKEEPER_ENABLED="true"
        print_ok "Gatekeeper: ENABLED"
        ((SECURITY_SCORE+=10))
    else
        print_fail "Gatekeeper: DISABLED"
    fi
    echo ""

    # 5. Remote Login (SSH)
    echo -e "${WHITE}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${WHITE}│  REMOTE LOGIN (SSH)                                         │${NC}"
    echo -e "${WHITE}└─────────────────────────────────────────────────────────────┘${NC}"

    SSH_ENABLED="false"
    if systemsetup -getremotelogin 2>/dev/null | grep -q "On"; then
        SSH_ENABLED="true"
        print_warn "Remote Login (SSH): ENABLED"

        # Check SSH config if exists
        if [ -f /etc/ssh/sshd_config ]; then
            ROOT_LOGIN=$(grep -E "^PermitRootLogin " /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}' || echo "yes")
            if [ "$ROOT_LOGIN" = "no" ]; then
                print_ok "SSH Root Login: DISABLED"
                ((SECURITY_SCORE+=5))
            else
                print_warn "SSH Root Login: ENABLED"
            fi
        fi
    else
        print_ok "Remote Login (SSH): DISABLED"
        ((SECURITY_SCORE+=5))
    fi
    echo ""

    # 6. Automatic Updates
    echo -e "${WHITE}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${WHITE}│  AUTOMATIC UPDATES                                          │${NC}"
    echo -e "${WHITE}└─────────────────────────────────────────────────────────────┘${NC}"

    AUTO_UPDATE=$(defaults read /Library/Preferences/com.apple.SoftwareUpdate AutomaticCheckEnabled 2>/dev/null || echo "0")
    if [ "$AUTO_UPDATE" = "1" ]; then
        print_ok "Automatic Update Check: ENABLED"
        ((SECURITY_SCORE+=5))
    else
        print_warn "Automatic Update Check: DISABLED"
    fi
    echo ""

    # 7. Open Ports
    echo -e "${WHITE}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${WHITE}│  OPEN PORTS (TCP LISTENING)                                 │${NC}"
    echo -e "${WHITE}└─────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    printf "   ${WHITE}%-8s %-15s %-25s %s${NC}\n" "PORT" "PROTOCOL" "PROCESS" "NOTE"
    echo "   ────────────────────────────────────────────────────────────"

    OPEN_PORTS=()
    while IFS= read -r line; do
        PORT=$(echo "$line" | awk '{print $4}' | sed 's/.*\.//' | sed 's/.*://')
        PROCESS=$(echo "$line" | awk '{print $1}')

        case "$PORT" in
            22)   NOTE="SSH" ;;
            443)  NOTE="HTTPS" ;;
            80)   NOTE="HTTP" ;;
            5900) NOTE="Screen Sharing" ;;
            3283) NOTE="Apple Remote Desktop" ;;
            *)    NOTE="" ;;
        esac

        printf "   %-8s %-15s %-25s %s\n" "$PORT" "tcp" "$PROCESS" "$NOTE"
        OPEN_PORTS+=("$PORT")
    done < <(lsof -iTCP -sTCP:LISTEN -n -P 2>/dev/null | tail -n +2 | head -15)

    echo ""
    print_info "Total open ports: ${#OPEN_PORTS[@]}"

    if [ ${#OPEN_PORTS[@]} -le 5 ]; then
        ((SECURITY_SCORE+=10))
    fi
    echo ""

    # Security Score
    echo -e "${WHITE}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${WHITE}║                    SECURITY SCORE                             ║${NC}"
    echo -e "${WHITE}╠═══════════════════════════════════════════════════════════════╣${NC}"

    if [ $SECURITY_SCORE -ge 60 ]; then
        SCORE_COLOR=$GREEN
        SCORE_LABEL="GOOD"
    elif [ $SECURITY_SCORE -ge 40 ]; then
        SCORE_COLOR=$YELLOW
        SCORE_LABEL="NEEDS IMPROVEMENT"
    else
        SCORE_COLOR=$RED
        SCORE_LABEL="CRITICAL"
    fi

    echo -e "${WHITE}║${NC}                                                               ${WHITE}║${NC}"
    echo -e "${WHITE}║${NC}          Current Score: ${SCORE_COLOR}${SECURITY_SCORE}/100 - ${SCORE_LABEL}${NC}               ${WHITE}║${NC}"
    echo -e "${WHITE}║${NC}                                                               ${WHITE}║${NC}"
    echo -e "${WHITE}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    INTERACTIVE HARDENING                      ║
# ╚═══════════════════════════════════════════════════════════════╝

HARDEN_FIREWALL="y"
HARDEN_STEALTH="y"
HARDEN_FILEVAULT="n"

interactive_hardening() {
    print_section "PHASE 2: HARDENING CONFIGURATION"
    echo ""

    # Check interactive
    if [ ! -t 0 ]; then
        print_info "Non-interactive mode. Using secure defaults."
        return
    fi

    # 1. Firewall
    echo -e "${CYAN}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│  [1/3] MACOS FIREWALL                                       │${NC}"
    echo -e "${CYAN}└─────────────────────────────────────────────────────────────┘${NC}"

    if [ "$FIREWALL_ENABLED" = "false" ]; then
        echo ""
        echo "   macOS Firewall blocks unauthorized incoming connections."
        echo ""
        if ask_yes_no "   Enable macOS Firewall?" "y"; then
            HARDEN_FIREWALL="y"
            print_ok "Firewall will be enabled"
        else
            HARDEN_FIREWALL="n"
        fi
    else
        print_ok "Firewall already enabled"
        HARDEN_FIREWALL="n"
    fi
    echo ""

    # 2. Stealth Mode
    echo -e "${CYAN}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│  [2/3] STEALTH MODE                                         │${NC}"
    echo -e "${CYAN}└─────────────────────────────────────────────────────────────┘${NC}"

    if [ "$FIREWALL_ENABLED" = "true" ] || [ "$HARDEN_FIREWALL" = "y" ]; then
        echo ""
        echo "   Stealth mode makes your Mac invisible to network scans."
        echo ""
        if ask_yes_no "   Enable Stealth Mode?" "y"; then
            HARDEN_STEALTH="y"
            print_ok "Stealth mode will be enabled"
        else
            HARDEN_STEALTH="n"
        fi
    else
        HARDEN_STEALTH="n"
    fi
    echo ""

    # 3. FileVault Info
    echo -e "${CYAN}┌─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│  [3/3] FILEVAULT                                            │${NC}"
    echo -e "${CYAN}└─────────────────────────────────────────────────────────────┘${NC}"

    if [ "$FILEVAULT_ENABLED" = "false" ]; then
        echo ""
        echo "   FileVault encrypts your entire disk."
        echo -e "   ${YELLOW}Note: FileVault must be enabled manually via System Preferences.${NC}"
        echo ""
        print_info "FileVault should be enabled via: System Preferences > Security & Privacy > FileVault"
    else
        print_ok "FileVault already enabled"
    fi
    echo ""
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    APPLY HARDENING                            ║
# ╚═══════════════════════════════════════════════════════════════╝

apply_hardening() {
    print_section "PHASE 3: APPLYING SECURITY HARDENING"
    echo ""

    if [ "$HARDEN_FIREWALL" = "y" ]; then
        echo -e "${WHITE}[1/2] Enabling macOS Firewall...${NC}"
        sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on 2>/dev/null || true
        print_ok "Firewall enabled"
        echo ""
    fi

    if [ "$HARDEN_STEALTH" = "y" ]; then
        echo -e "${WHITE}[2/2] Enabling Stealth Mode...${NC}"
        sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setstealthmode on 2>/dev/null || true
        print_ok "Stealth mode enabled"
        echo ""
    fi

    print_ok "Security hardening applied"
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    AGENT INSTALLATION                         ║
# ╚═══════════════════════════════════════════════════════════════╝

install_dependencies() {
    print_section "PHASE 4: INSTALLING DEPENDENCIES"
    echo ""

    # Check for autossh
    if ! command -v autossh &>/dev/null; then
        echo -e "${WHITE}Installing autossh...${NC}"
        if command -v brew &>/dev/null; then
            brew install autossh 2>/dev/null || true
            print_ok "autossh installed via Homebrew"
        else
            print_warn "Homebrew not found. Please install autossh manually:"
            print_info "  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
            print_info "  brew install autossh"
        fi
    else
        print_ok "autossh already installed"
    fi

    # Check for jq
    if ! command -v jq &>/dev/null; then
        echo -e "${WHITE}Installing jq...${NC}"
        if command -v brew &>/dev/null; then
            brew install jq 2>/dev/null || true
            print_ok "jq installed"
        fi
    else
        print_ok "jq already installed"
    fi
    echo ""
}

setup_agent() {
    print_section "PHASE 5: SETTING UP ORIZON AGENT"
    echo ""

    AGENT_DIR="/opt/orizon-agent"
    SSH_KEY_DIR="$AGENT_DIR/.ssh"

    echo -e "${WHITE}Creating agent directory...${NC}"
    sudo mkdir -p "$AGENT_DIR"
    sudo mkdir -p "$SSH_KEY_DIR"
    sudo chmod 700 "$SSH_KEY_DIR"
    print_ok "Agent directory: $AGENT_DIR"
    echo ""

    echo -e "${WHITE}Generating SSH key pair...${NC}"
    if [ ! -f "$SSH_KEY_DIR/id_ed25519" ]; then
        sudo ssh-keygen -t ed25519 -f "$SSH_KEY_DIR/id_ed25519" -N "" -C "orizon-agent-$NODE_ID"
        print_ok "SSH key generated"
    else
        print_info "SSH key already exists"
    fi
    echo ""

    echo -e "${WHITE}Registering SSH key with Hub...${NC}"
    PUBLIC_KEY=$(sudo cat "$SSH_KEY_DIR/id_ed25519.pub")

    REGISTER_RESPONSE=$(curl -fsSL -X POST "${API_BASE_URL}/nodes/$NODE_ID/register-key" \
        -H "Authorization: Bearer $AGENT_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"publicKey\": \"$PUBLIC_KEY\"}" 2>/dev/null || echo '{"error": "Failed"}')

    if echo "$REGISTER_RESPONSE" | grep -q '"success"'; then
        print_ok "SSH key registered with Hub"
    else
        print_warn "Key registration: $REGISTER_RESPONSE"
    fi
    echo ""

    echo -e "${WHITE}Creating agent configuration...${NC}"
    sudo tee "$AGENT_DIR/config.json" > /dev/null <<EOF
{
  "nodeId": "$NODE_ID",
  "nodeName": "$NODE_NAME",
  "hubHost": "$HUB_HOST",
  "hubSshPort": $HUB_SSH_PORT,
  "tunnels": {
    "terminal": {
      "localPort": $TERMINAL_LOCAL_PORT,
      "remotePort": $TERMINAL_REMOTE_PORT
    },
    "https": {
      "localPort": $HTTPS_LOCAL_PORT,
      "remotePort": $HTTPS_REMOTE_PORT
    }
  },
  "installedAt": "$(date -Iseconds)"
}
EOF
    print_ok "Configuration saved"
    echo ""
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    TUNNEL SERVICES                            ║
# ╚═══════════════════════════════════════════════════════════════╝

create_tunnel_services() {
    print_section "PHASE 6: CREATING TUNNEL SERVICES"
    echo ""

    AGENT_DIR="/opt/orizon-agent"
    SSH_KEY="$AGENT_DIR/.ssh/id_ed25519"

    # Terminal Tunnel LaunchDaemon
    echo -e "${WHITE}Creating Terminal Tunnel LaunchDaemon...${NC}"
    sudo tee /Library/LaunchDaemons/com.orizon.tunnel.terminal.plist > /dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.orizon.tunnel.terminal</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/autossh</string>
        <string>-M</string>
        <string>0</string>
        <string>-N</string>
        <string>-o</string>
        <string>ServerAliveInterval=30</string>
        <string>-o</string>
        <string>ServerAliveCountMax=3</string>
        <string>-o</string>
        <string>ExitOnForwardFailure=yes</string>
        <string>-o</string>
        <string>StrictHostKeyChecking=no</string>
        <string>-o</string>
        <string>UserKnownHostsFile=/dev/null</string>
        <string>-i</string>
        <string>$SSH_KEY</string>
        <string>-p</string>
        <string>$HUB_SSH_PORT</string>
        <string>-R</string>
        <string>$TERMINAL_REMOTE_PORT:localhost:$TERMINAL_LOCAL_PORT</string>
        <string>$NODE_ID@$HUB_HOST</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/var/log/orizon-tunnel-terminal.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/orizon-tunnel-terminal-error.log</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>AUTOSSH_GATETIME</key>
        <string>0</string>
        <key>AUTOSSH_POLL</key>
        <string>60</string>
    </dict>
</dict>
</plist>
EOF
    print_ok "Terminal tunnel daemon created"

    # HTTPS Tunnel LaunchDaemon
    echo -e "${WHITE}Creating HTTPS Tunnel LaunchDaemon...${NC}"
    sudo tee /Library/LaunchDaemons/com.orizon.tunnel.https.plist > /dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.orizon.tunnel.https</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/autossh</string>
        <string>-M</string>
        <string>0</string>
        <string>-N</string>
        <string>-o</string>
        <string>ServerAliveInterval=30</string>
        <string>-o</string>
        <string>ServerAliveCountMax=3</string>
        <string>-o</string>
        <string>ExitOnForwardFailure=yes</string>
        <string>-o</string>
        <string>StrictHostKeyChecking=no</string>
        <string>-o</string>
        <string>UserKnownHostsFile=/dev/null</string>
        <string>-i</string>
        <string>$SSH_KEY</string>
        <string>-p</string>
        <string>$HUB_SSH_PORT</string>
        <string>-R</string>
        <string>$HTTPS_REMOTE_PORT:localhost:$HTTPS_LOCAL_PORT</string>
        <string>$NODE_ID@$HUB_HOST</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/var/log/orizon-tunnel-https.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/orizon-tunnel-https-error.log</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>AUTOSSH_GATETIME</key>
        <string>0</string>
        <key>AUTOSSH_POLL</key>
        <string>60</string>
    </dict>
</dict>
</plist>
EOF
    print_ok "HTTPS tunnel daemon created"
    echo ""

    # Load daemons
    echo -e "${WHITE}Loading tunnel services...${NC}"
    sudo launchctl load /Library/LaunchDaemons/com.orizon.tunnel.terminal.plist 2>/dev/null || true
    sudo launchctl load /Library/LaunchDaemons/com.orizon.tunnel.https.plist 2>/dev/null || true
    print_ok "Tunnel services loaded"

    echo ""
    sleep 3

    if sudo launchctl list | grep -q "com.orizon.tunnel.terminal"; then
        print_ok "Terminal tunnel: RUNNING"
    else
        print_warn "Terminal tunnel: Check /var/log/orizon-tunnel-terminal-error.log"
    fi

    if sudo launchctl list | grep -q "com.orizon.tunnel.https"; then
        print_ok "HTTPS tunnel: RUNNING"
    else
        print_warn "HTTPS tunnel: Check /var/log/orizon-tunnel-https-error.log"
    fi
    echo ""
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    HARDENING REPORT                           ║
# ╚═══════════════════════════════════════════════════════════════╝

send_hardening_report() {
    print_section "PHASE 7: SENDING HARDENING REPORT"
    echo ""

    echo -e "${WHITE}Sending security status to Hub...${NC}"

    FW_ON=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null | grep -c "enabled" || echo "0")
    FV_ON=$(fdesetup status 2>/dev/null | grep -c "On" || echo "0")

    JSON_PAYLOAD=$(cat <<EOF
{
    "agent_token": "$AGENT_TOKEN",
    "firewall": {
        "enabled": $([ "$FW_ON" = "1" ] && echo "true" || echo "false"),
        "default_policy": "ALLOW"
    },
    "antivirus": {
        "enabled": true,
        "product_name": "XProtect"
    },
    "open_ports": [],
    "security_modules": [
        {"name": "Gatekeeper", "status": "$([ "$GATEKEEPER_ENABLED" = "true" ] && echo "enabled" || echo "disabled")"},
        {"name": "SIP", "status": "$([ "$SIP_ENABLED" = "true" ] && echo "enabled" || echo "disabled")"},
        {"name": "FileVault", "status": "$([ "$FV_ON" = "1" ] && echo "enabled" || echo "disabled")"}
    ],
    "ssl_info": {
        "openssl_version": "$(openssl version 2>/dev/null | awk '{print $2}' || echo "unknown")"
    },
    "audit": {
        "enabled": true,
        "service_name": "macOS Unified Logging"
    }
}
EOF
)

    RESPONSE=$(curl -s -X POST "${API_BASE_URL}/nodes/hardening" \
        -H "Content-Type: application/json" \
        -d "$JSON_PAYLOAD" 2>/dev/null || echo '{"error": "Failed"}')

    if echo "$RESPONSE" | grep -q '"status":"ok"'; then
        print_ok "Hardening report sent"
    else
        print_warn "Could not send report: $RESPONSE"
    fi
    echo ""
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    SUMMARY                                    ║
# ╚═══════════════════════════════════════════════════════════════╝

print_summary() {
    echo ""
    echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║              INSTALLATION COMPLETE                            ║${NC}"
    echo -e "${GREEN}╠═══════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}  Node ID:    $NODE_ID     ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}  Node Name:  $NODE_NAME                                        ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}  Hub:        $HUB_HOST:$HUB_SSH_PORT                           ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}  Tunnels:                                                     ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}    Terminal: localhost:$TERMINAL_LOCAL_PORT -> Hub:$TERMINAL_REMOTE_PORT    ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}    HTTPS:    localhost:$HTTPS_LOCAL_PORT -> Hub:$HTTPS_REMOTE_PORT     ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}                                                               ${GREEN}║${NC}"
    echo -e "${GREEN}╠═══════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${GREEN}║${NC}  Commands:                                                    ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}    sudo launchctl list | grep orizon                          ${GREEN}║${NC}"
    echo -e "${GREEN}║${NC}    tail -f /var/log/orizon-tunnel-terminal.log                ${GREEN}║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# ╔═══════════════════════════════════════════════════════════════╗
# ║                    MAIN                                       ║
# ╚═══════════════════════════════════════════════════════════════╝

main() {
    if [ "$EUID" -ne 0 ]; then
        echo "This script must be run with sudo"
        echo "Usage: sudo bash $0"
        exit 1
    fi

    print_banner
    detect_macos
    echo ""

    # Check for existing installation
    ACTION="install"
    check_existing_installation
    if [ "$EXISTING_INSTALLATION" = "true" ]; then
        show_existing_status

        if [ -t 0 ]; then
            prompt_existing_action
        else
            print_info "Non-interactive mode: proceeding with upgrade"
            ACTION="upgrade"
        fi

        # Handle uninstall
        if [ "$ACTION" = "uninstall" ]; then
            uninstall_agent
            exit 0
        fi

        # Handle status-only
        if [ "$ACTION" = "status" ]; then
            audit_security
            echo ""
            print_info "Status check complete. No changes made."
            exit 0
        fi

        # For modify or upgrade, continue
        print_info "Proceeding with $ACTION..."
        echo ""
    fi

    audit_security
    interactive_hardening

    print_section "PLANNED CHANGES"
    echo ""
    [ "$HARDEN_FIREWALL" = "y" ] && echo "   * Enable macOS Firewall"
    [ "$HARDEN_STEALTH" = "y" ] && echo "   * Enable Stealth Mode"
    echo "   * Install Orizon Agent"
    echo "   * Create reverse tunnels"
    echo ""

    if [ -t 0 ]; then
        if ! ask_yes_no "Proceed with installation?" "y"; then
            print_warn "Installation cancelled"
            exit 0
        fi
    fi
    echo ""

    apply_hardening
    install_dependencies
    setup_agent
    create_tunnel_services
    send_hardening_report
    print_summary
}

main "$@"
